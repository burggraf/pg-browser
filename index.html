<!doctype html>
<title>PostgreSQL</title><!-- not BASIC! -->

<script src="./js/libv86.js"></script>
<script src="./js/idb-storage.min.js"></script>
<script>
    "use strict";
    const storage = idbStorage.createIDBStorage({
        name: "state-storage",
        conflicAction: "replace"
    });
    const config = {
        font_size: 18,
        memory_size: 96,
        vga_memory_size: 2,
        initial_state: {
            url: "../images/pg-browser-state-96.bin.zst"
        },
    }
    var emulator;

    function setup_emulator() {
        console.log('loading emualtor');
        emulator = window.emulator = new V86Starter({
            wasm_path: "../images/v86.wasm",
            memory_size: config.memory_size * 1024 * 1024,
            vga_memory_size: config.vga_memory_size * 1024 * 1024,
            screen_container: document.getElementById("screen_container"),
            bios: {
                url: "../images/seabios.bin",
            },
            vga_bios: {
                url: "../images/vgabios.bin",
            },
            cdrom: {
                url: "../images/v86-linux.iso",
            },
            // fastboot: true,
            // network_relay_url: "ws://localhost:8080/",
            initial_state: config.initial_state,
            autostart: true,
        });
        console.log('emulator loaded', emulator);

        var state;

        document.getElementById("save_restore").onclick = async function () {
            var button = this;

            if (state) {
                button.value = "Save state";
                await emulator.restore_state(state);
                state = undefined;
            } else {
                const new_state = await emulator.save_state();
                console.log("Saved state of " + new_state.byteLength + " bytes");
                button.value = "Restore state";
                state = new_state;
            }

            button.blur();
        };

        document.getElementById("save_file").onclick = async function () {
            const new_state = await emulator.save_state();
            var a = document.createElement("a");
            a.download = "pg-browser-state-" + config.memory_size + ".bin";
            a.href = window.URL.createObjectURL(new Blob([new_state]));
            a.dataset.downloadurl = "application/octet-stream:" + a.download + ":" + a.href;
            a.click();

            this.blur();
        };

        document.getElementById("restore_file").onchange = function () {
            if (this.files.length) {
                var filereader = new FileReader();
                emulator.stop();

                filereader.onload = async function (e) {
                    await emulator.restore_state(e.target.result);
                    emulator.run();
                };

                filereader.readAsArrayBuffer(this.files[0]);

                this.value = "";
            }

            this.blur();
        };

        V86Starter.prototype.keyboard_send_text = function (string) {
            for (var i = 0; i < string.length; i++) {
                this.keyboard_adapter.simulate_char(string[i]);
            }
        };


        emulator.clearState = async function () {
            await storage.delete('state');
        }
        emulator.save = async function () {
            console.log('saving...');
            await emulator.clearState();
            const state = await emulator.save_state();
            const meta = {};
            const result = await storage.set('state', state, meta);
            console.log('save result', result);
        }

        emulator.restore = async function () {
            console.log('restoring...');
            storage.get("state").then(function (state) {
                if (state) {
                    emulator.stop();
                    emulator.restore_state(state).then(function (result) {
                        console.log('restore result', result);
                        emulator.run();
                    }).catch(function (err) {
                        console.log('restore error', err);
                    });
                }
            }).catch(function (err) {
                console.log('restore error', err);
            });
        }
        emulator.add_listener("emulator-started", function() {
            console.log('*** emulator started');
        });
        emulator.add_listener("emulator-stopped", function() {
            console.log('*** emulator stopped');
        });
        emulator.add_listener("emulator-ready", function() {
            console.log('*** emulator ready');
        });
        emulator.add_listener("download-progress", function(e)
        {
            console.log('*** download progress', e);
            if (e.file_name.startsWith("../images/pg-browser-state")) {
                const el = document.getElementById("progress");
                const percent = (e.loaded / Math.max(e.total,1)) * 100;
                // format percent with 2 decimal places
                el.innerHTML = percent.toFixed(2) + "%";
            }
            /*
            file_count: 4
            file_index: 3
            file_name: "../images/pg-browser-state-96.bin.zst"
            lengthComputable: true
            loaded: 24793069
            total: 24793069
            */
        });  
        emulator.add_listener("9p-attach", function()
        {
            console.log('*** 9p-attach');
        });      

    }
    window.onload = function () {
        setup_emulator();
        setTimeout(function () {
            emulator.restore(); // restore from indexedDB storage
            console.log('*** done restoring emulator', emulator);
        }, 500);

    }

    function updateFontSize() {
        const newFontSize = document.getElementById("fontsize").value;
        document.getElementById("text_container").style.fontSize = newFontSize + "px";
        document.getElementById("text_container").style.lineHeight = newFontSize + "px";
    }

    function updateMemorySize() {
        const fullboot = document.getElementById("fullboot").checked;
        const newMemorySize = document.getElementById("memorysize").value;
        console.log('new memory size', newMemorySize);
        try {
            config.memory_size = parseInt(newMemorySize, 10) || 96;
            if (!config.memory_size || config.memory_size < 96) {
                config.memory_size = 96;
                document.getElementById("memorysize").value = config.memory_size;
            }
            if (fullboot) {
                config.initial_state = null;
            } else {
                config.initial_state.url = "../images/pg-browser-state-" + config.memory_size + ".bin.zst";
            }
            emulator.stop();
            setup_emulator();
        } catch (e) {
            console.log('updateMemorySize error', e);
        }
    }
</script>

<!-- A minimal structure for the ScreenAdapter defined in browser/screen.js -->
<div>Progress: <span id="progress"></span></div>
<div id="screen_container">
    <div id="text_container" style="white-space: pre; font: 18px monospace; line-height: 18px"></div>
    <canvas style="display: none;"></canvas>
</div>

<hr>

<input id="save_restore" type="button" value="Save state">
<input id="save_file" type="button" value="Save state to file">
Restore from file: <input id="restore_file" type="file">
<br />
<button onclick="emulator.save()">Save to IndexedDB</button>&nbsp;&nbsp;
<button onclick="emulator.restore()">Restore from IndexedDB</button>&nbsp;&nbsp;
<button onclick="emulator.clearState()">Clear IndexedDB</button>
<br />
<input type="text" id="fontsize" value="18" min="4" max="40" style="width: 25px">&nbsp;&nbsp;<button
    onclick="updateFontSize()">Update font size</button>
<br />
memory (mb): <select name="memorysize" id="memorysize">
    <option value="96">96</option>
    <option value="128">128</option>
    <option value="196">196</option>
    <option value="256">256</option>
    <option value="384">384</option>
    <option value="512">512</option>
    <option value="1024">1024</option>
</select>
<!-- <input type="text" id="memorysize" value="96" min="96" max="8192" style="width: 35px">-->&nbsp;&nbsp;<button
    onclick="updateMemorySize()">Update memory size</button>
&nbsp;&nbsp;<input type="checkbox" id="fullboot" name="fullboot" value="true"> Full Boot
<br /><br /><br />
<textarea id="textarea" cols="80" rows="10"></textarea><br>
<button onclick="emulator.keyboard_send_text(document.getElementById('textarea').value)">Send Text</button>